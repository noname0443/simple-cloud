apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "mysql-chart.fullname" . }}-add-hosts-to-mysync"
  namespace: mysql
  labels:
    {{- include "mysql-chart.labels" . | nindent 4 }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    purpose: job
  annotations:
    "helm.sh/hook-delete-policy": before-hook-creation,post-install,post-upgrade
    "helm.sh/hook": post-install
    "helm.sh/hook-weight": "2"
spec:
  serviceAccountName: {{ include "mysql-chart.serviceAccountName" . }}
  containers:
    - name: ping-conn
      image: "k8s.gcr.io/hyperkube:v1.12.1"
      imagePullPolicy: "IfNotPresent"
      command:
      - /bin/bash
      - -c
      - > 
          set -e

          for((i = 0; i < {{ .Values.replicaCount }}; i++)) do
            sleep {{ .Values.createSlaveWaitTime }};
            kubectl exec -n mysql -c mysql {{ .Release.Name }}-0 -- mysync host add {{ .Release.Name }}-$i.{{ .Release.Name }}-mysql-cluster.mysql.svc.cluster.local;
          done;

          exit 0;
  restartPolicy: Never