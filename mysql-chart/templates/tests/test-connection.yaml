apiVersion: v1
kind: Pod
metadata:
  name: "test-{{ include "mysql-chart.fullname" . }}-host-connection"
  labels:
    {{- include "mysql-chart.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook-delete-policy": before-hook-creation,post-install,post-upgrade
    "helm.sh/hook": test,post-install
    "helm.sh/hook-weight": "1"
spec:
  serviceAccountName: {{ include "mysql-chart.serviceAccountName" . }}
  containers:
    - name: ping
      image: "k8s.gcr.io/hyperkube:v1.12.1"
      imagePullPolicy: "IfNotPresent"
      command:
      - /bin/bash
      - -c
      - > 
          i=0;
          len=$(kubectl get pods --no-headers | grep '{{ include "mysql-chart.fullname" . }}-[0-9]' | wc -l);

          echo "HOST COUNT ${len}";

          for((i = 0; i < len; i++)) do
            IP=$(kubectl get pods "{{ include "mysql-chart.fullname" . }}-$i" -o wide --no-headers  | tail -n 1 | awk '{ print $6 }';);
            ping -c 3 $IP;
            echo $?;
            if [ $? != "0" ]; then
              exit 1;
            fi;
          done;

          exit 0;
  restartPolicy: Never