apiVersion: v1
kind: Pod
metadata:
  name: "test-{{ include "mysql-chart.fullname" . }}-host-connection"
  namespace: mysql
  labels:
    {{- include "mysql-chart.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook-delete-policy": before-hook-creation,post-install,post-upgrade
    "helm.sh/hook": test,post-install
    "helm.sh/hook-weight": "1"
spec:
  serviceAccountName: {{ include "mysql-chart.serviceAccountName" . }}
  containers:
    - name: ping-and-mysql-conn
      image: "k8s.gcr.io/hyperkube:v1.12.1"
      imagePullPolicy: "IfNotPresent"
      command:
      - /bin/bash
      - -c
      - > 
          set -e

          len=$(kubectl get pods --no-headers -n mysql | grep "{{ .Release.Name }}-[0-9]" | wc -l);

          echo "HOST COUNT ${len}";

          i=0;
          for((i = 0; i < len; i++)) do
            IP=$(kubectl get pods "{{ .Release.Name }}-$i" -o wide --no-headers -n mysql | tail -n 1 | awk '{ print $6 }';);
            ping -c 3 $IP;
          done;

          exit 0;
  restartPolicy: Never