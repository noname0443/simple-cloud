apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "mysql-chart.fullname" . }}-create-slave"
  namespace: mysql
  labels:
    {{- include "mysql-chart.labels" . | nindent 4 }}
    app.kubernetes.io/instance: {{ .Release.Name }}
  annotations:
    "helm.sh/hook-delete-policy": before-hook-creation,post-install,post-upgrade
    "helm.sh/hook": post-install
    "helm.sh/hook-weight": "3"
spec:
  serviceAccountName: {{ include "mysql-chart.serviceAccountName" . }}
  containers:
    - name: mysql-conn
      image: "mysql:8.0"
      imagePullPolicy: "IfNotPresent"
      command:
      - /bin/bash
      - -c
      - > 
          set -e

          pass=$(tr -dc A-Za-z0-9 </dev/urandom | head -c 13 ; echo '');

          mysql -h "{{ .Release.Name }}-0.{{ .Release.Name }}-mysql-cluster.mysql.svc.cluster.local" -p{{ .Values.mysql.password }} -u root -e "CREATE USER 'repl'@'%' IDENTIFIED WITH mysql_native_password BY '$pass';GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';FLUSH PRIVILEGES;";

          pos=$(mysql -h "{{ .Release.Name }}-0.{{ .Release.Name }}-mysql-cluster.mysql.svc.cluster.local" -p{{ .Values.mysql.password }} -u root -e "show master status" 2>/dev/null | tail -n 1 | awk '{ printf $2; }');
          file=$(mysql -h "{{ .Release.Name }}-0.{{ .Release.Name }}-mysql-cluster.mysql.svc.cluster.local" -p{{ .Values.mysql.password }} -u root -e "show master status" 2>/dev/null | tail -n 1 | awk '{ printf $1; }');

          for((i = 1; i < {{ .Values.replicaCount }}; i++)) do
            mysql -h "{{ .Release.Name }}-$i.{{ .Release.Name }}-mysql-cluster.mysql.svc.cluster.local" -p{{ .Values.mysql.password }} -u root -e "CHANGE REPLICATION SOURCE TO SOURCE_HOST='{{ .Release.Name }}-0.{{ .Release.Name }}-mysql-cluster.mysql.svc.cluster.local', SOURCE_USER='repl', SOURCE_PASSWORD='$pass', SOURCE_LOG_FILE='$file', SOURCE_LOG_POS=$pos;start replica;";
          done;

          exit 0;
  restartPolicy: Never